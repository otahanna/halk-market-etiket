<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Halk Market (Ortalı KDV)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

  <style>
    body{ font-family: 'Comic Sans MS', 'Comic Sans', cursive, sans-serif; background-color:#374151; -webkit-print-color-adjust: exact; margin:0; padding:0; }
    
    @media print{
      @page{ margin: 0; }
      
      html, body{ margin:0 !important; padding:0 !important; background:#fff !important; color:#000 !important; }
      .no-print{ display:none !important; }
      #previewArea, .print-area{ background:#fff !important; padding:0 !important; margin:0 !important; overflow:visible !important; display:block !important; }
      
      /* A4 BASKI AYARI (Üst:4.5cm, Alt:3cm) */
      .size-a4 { 
        width:210mm; 
        height:297mm; 
        padding: 45mm 10mm 30mm 10mm !important; 
        page-break-after: always;
      }
      
      /* A5 BASKI AYARI (Üst:3.5cm, Alt:2.5cm) */
      .size-a5 { 
          width:148mm; 
          height:210mm; 
          padding: 35mm 5mm 25mm 5mm !important; 
          page-break-after: always;
      }

      /* RAF ETİKETİ (Yedek.html Mantığı) */
      .size-shelf {
          width: 150mm !important;
          height: 135mm !important;
          padding: 0 !important;
          page-break-after: always;
      }

      .size-a5l {
        width: 148mm !important; height: 210mm !important;
        position: absolute !important; top: 0 !important; left: 0 !important;
        transform: translateY(148mm) rotate(-90deg) !important;
        transform-origin: top left !important;
        margin: 0 !important; border: none !important; page-break-after: always;
      }

      .label-card, .header-box, .content-box, .footer-info, .strip-label { 
          border:none !important; 
          box-shadow:none !important; 
          margin:0 !important; 
      }
    }

    /* EKRAN GÖRÜNÜMÜ */
    .label-card{ background:white; margin:auto; position:relative; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 10px 25px rgba(0,0,0,0.5); box-sizing:border-box; align-items:center; color:black; border:none; }
    
    .size-a4{ width:210mm; height:297mm; padding: 45mm 10mm 30mm 10mm !important; }
    .size-a5{ width:148mm; height:210mm; padding: 35mm 5mm 25mm 5mm !important; }
    
    .size-shelf{ width:150mm; height:135mm; padding:0 !important; } 
    
    .size-a5l{ width:148mm; height:210mm; padding:5mm; margin: 30px auto; border: 2px dashed red; }
    .size-a5l::before { content: "YAZICIDAN YATAY ÇIKACAK"; display: block; width: 100%; text-align: center; color: red; font-size: 10px; font-weight: bold; position: absolute; top: -20px; left: 0; }
    @media print { .size-a5l::before { display: none; } .size-a5l { border: none; } }
    
    .size-a3{ width:297mm; height:420mm; padding:15mm; }

    /* DÜZEN */
    .header-box{ width:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; border-bottom:none; flex-shrink:0; text-align:center; overflow:hidden; padding:0; box-sizing:border-box; }
    
    .content-box{ width:100%; flex:1; border:none; border-radius:0; display:flex; flex-direction:column; align-items:center; justify-content:center; margin:0; position:relative; background:white; overflow:hidden; box-sizing:border-box; }
    .size-shelf .content-box { margin: 5px 0 !important; padding: 0 5px; } 

    .price-row{ display:flex; align-items:flex-start; justify-content:center; line-height:0.75; margin-top: 10px; }
    .size-shelf .price-row { margin-top: 0; } 

    .price-left{ font-weight:900; letter-spacing:-4px; line-height: 0.8; }
    .price-right{ display:flex; flex-direction:column; margin-left:15px; padding-top:10px; }
    .size-shelf .price-right { margin-left: 5px; padding-top: 5px; } 
    
    .kurus{ border-bottom:none; margin-bottom:4px; line-height:0.8; }
    .tl{ line-height:0.8; }

    .footer-info{ width:100%; display:flex; justify-content:space-between; align-items:flex-end; margin-top:5px; padding-top:0; border-top:none; flex-shrink:0; gap:8px; box-sizing:border-box; }
    .size-shelf .footer-info { padding: 0 10px 10px 10px; margin-top: 0; align-items: flex-end !important; }

    /* Logo Sola Dayalı */
    .yerli-logo-box{ display:flex; align-items:center; justify-content: flex-start; border:none; background:white; color:black; flex-shrink:0; }

    .multi-sheet{ width:210mm; min-height:297mm; background:white; padding-top:5mm; display:flex; flex-direction:column; align-items:center; gap:5mm; box-shadow:0 0 15px rgba(0,0,0,0.5); margin:0 auto 20px auto; }
    .strip-label{ width:200mm; height:92mm; border:none; display:flex; box-sizing:border-box; overflow:hidden; background:white; }
    .strip-left{ flex:0 0 60%; padding:10px 12px; display:flex; flex-direction:column; justify-content:space-between; }
    .strip-right{ flex:0 0 40%; padding:10px 12px; display:flex; align-items:center; justify-content:center; }

    /* Barkod Kutusu: Ortalanmış */
    .barcode-container { 
        display: flex; 
        flex-direction: column; 
        align-items: center; /* Barkod ve Yazıyı Ortalar */
        justify-content: flex-end;
        width: fit-content; /* Sadece içeriği kadar yer kaplar */
    }
    .barcode-svg { display:block; } /* width:100% KALDIRILDI */
    
    .fold-area{ display:none; width:100%; height:35mm; background:#fff; border-bottom:1px dashed #ccc; align-items:center; justify-content:center; font-weight:bold; font-size:12px; flex-shrink:0; }
    .size-shelf .fold-area{ display:flex; } 

    .btn-active{ background-color:white; color:black; border:2px solid white; }
    .btn-passive{ background-color:#374151; color:#9ca3af; border:2px solid #4b5563; }
    .clamp-2{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  </style>
</head>

<body class="bg-gray-50">

  <div class="flex h-screen overflow-hidden">
    <div class="w-96 bg-gray-900 text-white flex flex-col z-50 no-print border-r border-gray-700 shadow-2xl">
      <div class="p-6 bg-red-900 border-b border-gray-700">
        <h1 class="text-2xl font-black italic">HALK MARKET</h1>
        <p class="text-xs text-gray-200 mt-2">Özel Punto & Marj Ayarlı</p>
      </div>

      <div class="flex-1 overflow-y-auto p-6 space-y-6 bg-gray-900">
        <div>
          <label class="text-xs font-bold text-gray-500 mb-2 block uppercase">ÇALIŞMA MODU</label>
          <div class="flex gap-2">
            <button onclick="setMode('single')" id="btn-mode-single" class="flex-1 p-3 rounded font-bold border-2 bg-white text-black">TEKLİ BASIM</button>
            <button onclick="setMode('multi')" id="btn-mode-multi" class="flex-1 p-3 rounded font-bold border-2 bg-gray-800 text-gray-400 border-gray-600">ÇOKLU A4 (3'lü)</button>
          </div>
        </div>

        <div id="size-options">
          <label class="text-xs font-bold text-gray-500 mb-2 block uppercase">Kağıt Boyutu</label>
          <div class="grid grid-cols-2 gap-2">
            <button onclick="setSize('size-a4', this)" class="size-btn btn-active w-full py-2 rounded font-bold">A4</button>
            <button onclick="setSize('size-a5', this)" class="size-btn btn-passive w-full py-2 rounded font-bold">A5 DİKEY</button>
            <button onclick="setSize('size-a5l', this)" class="size-btn btn-passive w-full py-2 rounded font-bold">A5 YATAY</button>
            <button onclick="setSize('size-a3', this)" class="size-btn btn-passive w-full py-2 rounded font-bold">A3</button>
            <button onclick="setSize('size-shelf', this)" class="size-btn btn-passive w-full py-2 rounded font-bold">RAF (15x13.5)</button>
          </div>
        </div>

        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
          <label class="text-xs font-bold text-gray-400 mb-2 block uppercase">Ürün Barkodu Okut</label>
          <form id="searchForm" onsubmit="event.preventDefault(); urunIsle();" class="flex gap-2">
            <input type="text" id="barkod" class="w-full bg-gray-900 border border-gray-600 rounded p-3 text-white font-mono font-bold text-lg outline-none focus:border-red-500" placeholder="Barkod..." autofocus autocomplete="off">
            <button type="submit" class="bg-red-600 text-white px-4 rounded font-bold hover:bg-red-700">
              <i class="fa-solid fa-plus"></i>
            </button>
          </form>
          <div id="queueCount" class="text-right text-xs text-yellow-500 mt-2 hidden">Listede: 0 Ürün</div>
          <div id="errorMsg" class="text-red-500 text-xs font-bold mt-2 hidden"></div>
        </div>

        <div>
          <label class="text-xs font-bold text-gray-500 mb-2 block uppercase">Kampanya Tipi</label>
          <div class="space-y-2">
            <button onclick="setKampanya('normal')" id="btn-camp-normal" class="camp-btn w-full p-3 rounded border-2 border-white bg-white text-black text-left font-bold">Standart Fiyat</button>
            <button onclick="setKampanya('3al2ode')" id="btn-camp-3al2ode" class="camp-btn w-full p-3 rounded border border-gray-600 bg-gray-800 text-gray-400 text-left">3 Al 2 Öde</button>
            <button onclick="setKampanya('1al1bedava')" id="btn-camp-1al1bedava" class="camp-btn w-full p-3 rounded border border-gray-600 bg-gray-800 text-gray-400 text-left">1 Alana 1 Bedava</button>
            <button onclick="setKampanya('2ci50')" id="btn-camp-2ci50" class="camp-btn w-full p-3 rounded border border-gray-600 bg-gray-800 text-gray-400 text-left">2.si %50 İndirim</button>
          </div>
        </div>

        <div class="mt-auto pt-4 border-t border-gray-700">
          <button onclick="printNow()" class="w-full bg-white text-black py-4 rounded font-black text-2xl hover:bg-gray-200 shadow-lg border-4 border-black flex items-center justify-center gap-2">
            <i class="fa-solid fa-print"></i> YAZDIR
          </button>
          <button onclick="clearQueue()" id="btnClear" class="w-full mt-2 bg-red-800 text-white py-2 rounded font-bold text-sm hover:bg-red-700 hidden">LİSTEYİ TEMİZLE</button>
        </div>
      </div>
    </div>

    <div class="flex-1 bg-gray-500 overflow-auto flex justify-center items-start p-8 print-area" id="previewArea">
       <div class='text-white text-2xl font-bold mt-10 opacity-50'>Barkod okutarak başlayın...</div>
    </div>
  </div>

  <script>
    // --- SUPABASE & CLIENT ---
    const SUPABASE_URL = "https://asixtbjdsypmobadjyeh.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFzaXh0Ympkc3lwbW9iYWRqeWVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0NjU5MjcsImV4cCI6MjA4NDA0MTkyN30.YODCqUCmG2VG-w5I1Al6qJE60v25FWeKBH9qx05Irfw";
    const { createClient } = supabase;
    const client = createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- STATE ---
    let state = { mode:'single', size:'size-a4', campaign:'normal', queue:[], activeProduct:null };

    function setMode(m){
      state.mode = m;
      document.getElementById('btn-mode-single').className = m==='single' ? "flex-1 p-3 rounded font-bold border-2 bg-white text-black" : "flex-1 p-3 rounded font-bold border-2 bg-gray-800 text-gray-400 border-gray-600";
      document.getElementById('btn-mode-multi').className = m==='multi' ? "flex-1 p-3 rounded font-bold border-2 bg-white text-black" : "flex-1 p-3 rounded font-bold border-2 bg-gray-800 text-gray-400 border-gray-600";
      
      const sizeDiv = document.getElementById('size-options');
      if(m==='multi'){ sizeDiv.style.opacity='0.3'; sizeDiv.style.pointerEvents='none'; }
      else { sizeDiv.style.opacity='1'; sizeDiv.style.pointerEvents='auto'; }

      document.getElementById('queueCount').classList.toggle('hidden', m==='single');
      document.getElementById('btnClear').classList.toggle('hidden', m==='single');

      if(m==='multi'){ state.queue=[]; updateQueueCount(); }
      render();
    }

    function setSize(s, btn){
      state.size = s;
      document.querySelectorAll('.size-btn').forEach(b=> b.className="size-btn btn-passive w-full py-2 rounded font-bold");
      if(btn) btn.className="size-btn btn-active w-full py-2 rounded font-bold";
      render();
    }

    function setKampanya(c){
      state.campaign = c;
      document.querySelectorAll('.camp-btn').forEach(b=> b.className="camp-btn w-full p-3 rounded border border-gray-600 bg-gray-800 text-gray-400 text-left");
      document.getElementById('btn-camp-'+c).className="camp-btn w-full p-3 rounded border-2 border-white bg-white text-black text-left font-bold";
      if(state.mode==='single') render();
    }

    async function urunIsle(){
      const input = document.getElementById('barkod');
      const err = document.getElementById('errorMsg');
      const kod = (input.value||'').trim();
      if(!kod) return;

      err.classList.add('hidden');
      try {
        const { data, error } = await client.from('urunler').select('*').eq('barkod', kod).maybeSingle();

        if(error) throw error;
        if(!data) {
           err.textContent = "Ürün bulunamadı!";
           err.classList.remove('hidden');
           input.select();
           return;
        }

        const p = {
            barkod: data.barkod,
            ad: data.ad,
            fiyat: data.fiyat,
            birimText: data.birim,
            gramaj: (data.gramaj ?? data.GRAMAJ ?? null),
            gramajTipi: (data.gramajtipi ?? data.GRAMAJTIPI ?? data.gramaj_tipi ?? null),
            tarih: data.tarih
        };

        if(state.mode==='single'){ state.activeProduct = p; }
        else { state.queue.push(p); updateQueueCount(); }

        input.value="";
        input.focus();
        render();
      } catch(e) {
        console.error(e);
        err.textContent = "Bağlantı hatası!";
        err.classList.remove('hidden');
      }
    }

    function updateQueueCount(){
      document.getElementById('queueCount').innerText = `Listede: ${state.queue.length} Ürün`;
    }

    function clearQueue(){ state.queue=[]; updateQueueCount(); render(); }
    function printNow(){ window.print(); }

    // --- BİRİM FİYAT MOTORU (YEDEK.HTML'DEN) ---
    function getDynamicUnitInfo(product, currentPrice) {
        const price = Number(currentPrice || 0);
        const fmt = (n) => (Number.isFinite(n) ? n.toFixed(2) : "0.00");

        const parseNum = (v) => {
            if (v === null || v === undefined) return NaN;
            let t = String(v).trim();
            t = t.replace(',', '.');
            t = t.replace(/[^0-9.\-]/g, '');
            const n = parseFloat(t);
            return Number.isFinite(n) ? n : NaN;
        };

        const fmtQty = (v) => {
            const n = parseNum(v);
            if (!Number.isFinite(n)) return "";
            let s = n.toFixed(3).replace(/\.0+$/,'').replace(/(\.[0-9]*?)0+$/,'$1');
            return s.replace('.', ',');
        };

        const gramaj = parseNum(product && (product.gramaj ?? product.GRAMAJ));
        const tipRaw = product && (product.gramajTipi ?? product.gramajtipi ?? product.GRAMAJTIPI ?? product.gramaj_tipi ?? "");
        const tip = String(tipRaw || "").trim().toUpperCase().replace(/İ/g, 'I');

        if (Number.isFinite(gramaj) && gramaj > 0 && tip) {
            if (["ADET","TANE","AD","PCS"].includes(tip)) {
                if (gramaj > 1) {
                    const tane = price / gramaj;
                    return `${fmtQty(gramaj)} adet (Tane: ${fmt(tane)} TL)`;
                }
                return `Birim: ${fmt(price)} TL`;
            }
            if (["GR","G"].includes(tip)) {
                const kgPrice = (price * 1000) / gramaj;
                return `${fmtQty(gramaj)} gr (Kg: ${fmt(kgPrice)} TL)`;
            }
            if (["KG","KILOGRAM","KİLOGRAM"].includes(tip)) {
                const kgPrice = price / gramaj;
                return `${fmtQty(gramaj)} kg (Kg: ${fmt(kgPrice)} TL)`;
            }
            if (["ML"].includes(tip)) {
                const ltPrice = (price * 1000) / gramaj;
                return `${fmtQty(gramaj)} ml (Lt: ${fmt(ltPrice)} TL)`;
            }
            if (["CL"].includes(tip)) {
                const ltPrice = (price * 100) / gramaj;
                return `${fmtQty(gramaj)} cl (Lt: ${fmt(ltPrice)} TL)`;
            }
            if (["LT","L","LTR","LITRE","LİTRE"].includes(tip)) {
                const ltPrice = price / gramaj;
                return `${fmtQty(gramaj)} lt (Lt: ${fmt(ltPrice)} TL)`;
            }
        }

        let rawUnit = (product && (product.birimText ?? product.birim ?? "")) ? String(product.birimText ?? product.birim).trim() : "";
        const uName = (product && product.ad) ? String(product.ad).trim() : "";
        
        let sourceText = rawUnit;
        const rawUpper = rawUnit.toUpperCase().replace(/İ/g, 'I');
        
        if (!rawUnit || rawUpper === 'ADET' || rawUpper === '1 ADET' || rawUpper === 'TANE') {
            sourceText = uName;
        }

        return getDynamicUnitInfoFromText(sourceText, price);
    }

    function getDynamicUnitInfoFromText(textSource, currentPrice) {
        const price = Number(currentPrice || 0);
        const fmt = (n) => (Number.isFinite(n) ? n.toFixed(2) : "0.00");
        
        if (!textSource || !String(textSource).trim()) {
            return `Birim: ${fmt(price)} TL`;
        }

        const raw = String(textSource).trim();
        const txt = raw.toUpperCase().replace(/İ/g, 'I');
        
        const parseTR = (s) => {
            let t = s.replace(',', '.');
            return parseFloat(t);
        };

        let m = txt.match(/(\d+(?:[\.,]\d+)?)\s*(?:LT|L|LITRE|LİTRE)/);
        if (m) {
            const lt = parseTR(m[1]);
            if (lt > 0) {
                const ltPrice = price / lt;
                return `${m[1].replace('.', ',')} Lt (Lt: ${fmt(ltPrice)} TL)`;
            }
        }

        m = txt.match(/(\d+(?:[\.,]\d+)?)\s*ML/);
        if (m) {
            const ml = parseTR(m[1]);
            if (ml > 0) {
                const ltPrice = (price * 1000) / ml;
                return `${m[1].replace('.', ',')} ml (Lt: ${fmt(ltPrice)} TL)`;
            }
        }

        m = txt.match(/(\d+(?:[\.,]\d+)?)\s*(?:GR|G|GRAM)/);
        if (m) {
            const gr = parseTR(m[1]);
            if (gr > 0) {
                const kgPrice = (price * 1000) / gr;
                return `${m[1].replace('.', ',')} gr (Kg: ${fmt(kgPrice)} TL)`;
            }
        }

        m = txt.match(/(\d+(?:[\.,]\d+)?)\s*(?:KG|KILO|KİLO)/);
        if (m) {
            const kg = parseTR(m[1]);
            if (kg > 0) {
                const kgPrice = price / kg;
                return `${m[1].replace('.', ',')} kg (Kg: ${fmt(kgPrice)} TL)`;
            }
        }

        if (txt.includes("KG") || txt.includes("KİLO")) {
             return `Birim: ${fmt(price)} TL / Kg`;
        }

        m = txt.match(/(\d+)\s*(?:ADET|TANE|PAKET|LI|Lİ)/);
        if (m) {
            const adet = parseTR(m[1]);
            if (adet > 1) {
                const tane = price / adet;
                return `${adet} ADET (Tane: ${fmt(tane)} TL)`;
            }
        }
        
        if (textSource.length > 15) { 
             return `Birim: ${fmt(price)} TL`;
        }

        return raw;
    }

    // --- RENDER ---
    function render(){
      const container = document.getElementById('previewArea');
      container.innerHTML = "";

      if(state.mode==='single'){
        if(state.activeProduct) container.appendChild(createLabel(state.activeProduct, state.size));
        else container.innerHTML = "<div class='text-white text-2xl font-bold mt-10 opacity-50'>Barkod okutun...</div>";
      } else {
        if(state.queue.length===0) container.innerHTML = "<div class='text-white text-2xl font-bold mt-10 opacity-50'>Listeye ürün ekleyin...</div>";
        for(let i=0;i<state.queue.length;i+=3){
          const sheet = document.createElement('div');
          sheet.className = "multi-sheet";
          for(let j=0;j<3;j++){
            if(state.queue[i+j]) sheet.appendChild(createLabel(state.queue[i+j], 'strip-label'));
          }
          container.appendChild(sheet);
        }
      }
      
      // Barkodları oluştur
      document.querySelectorAll(".barcode-gen").forEach(svg => {
         const val = svg.getAttribute("jsbarcode-value");
         if(val){
             try {
                 const isShelf = svg.closest('.size-shelf') !== null;
                 const isA5 = svg.closest('.size-a5') !== null || svg.closest('.size-a5l') !== null;
                 
                 // Çubuk kalınlığı (width) ayarı - İnceltildi
                 let barWidth = 1.5; 
                 if(isShelf) barWidth = 1.3; 
                 if(isA5) barWidth = 1.4;

                 JsBarcode(svg, val, {
                    format: "CODE128",
                    lineColor: "#000",
                    width: barWidth,
                    height: 40, // Base height, CSS ile ezilecek
                    displayValue: true,
                    text: val,
                    fontSize: isShelf ? 12 : 14,
                    marginTop: 2,
                    fontOptions: "bold"
                 });
             } catch(e) { console.error(e); }
         }
      });
    }

    // --- LABEL OLUŞTURUCU ---
    function createLabel(product, sizeClass){
      const el = document.createElement('div');
      el.className = (sizeClass==='strip-label') ? 'strip-label' : `label-card ${sizeClass}`;

      const normalFiyat = parseFloat(product.fiyat||0);
      let satisFiyat = normalFiyat;
      let baslik = ""; 
      let altBaslik = "";
      let dipNot = "";
      let isCampaign = false;

      // Kampanya Mantığı
      const camp = state.campaign;
      if(camp!=='normal'){
        isCampaign = true;
        if(camp==='3al2ode'){ satisFiyat=(normalFiyat*2)/3; baslik="3 AL 2 ÖDE"; altBaslik="ÇOKLU ALIM"; dipNot="3 ADET ALIMDA BİRİM FİYATTIR"; }
        if(camp==='1al1bedava'){ satisFiyat=normalFiyat/2; baslik="1 ALANA 1 BEDAVA"; altBaslik="YARI FİYATINA"; dipNot="2 ADET ALIMDA BİRİM MALİYET"; }
        if(camp==='2ci50'){ satisFiyat=normalFiyat*0.75; baslik="İKİNCİSİ %50"; altBaslik="FIRSAT"; dipNot="ORTALAMA MALİYET"; }
      }

      const dinamikBirimText = getDynamicUnitInfo(product, satisFiyat);
      const [tam, kurus] = satisFiyat.toFixed(2).split('.');
      const isYerli = (product.barkod||"").startsWith('868') || (product.barkod||"").startsWith('869');
      const uretimYeri = isYerli ? "TÜRKİYE" : "İTHAL";

      // --- PUNTO VE BOYUT AYARLARI (CONFIG) ---
      let s = {};

      if(sizeClass === 'size-a5' || sizeClass === 'size-a5l') {
          // A5: Logo 1.2cm, Barkod 0.7cm
          s = {
              urun: '55pt',
              big: '90pt',
              small: '45pt',
              tl: '30pt',
              logoH: '1.2cm',
              info: '10pt',
              barcodeH: '0.7cm' 
          };
      } 
      else if (sizeClass === 'size-a4') {
          // A4: Logo 1.8cm, Barkod 1.0cm
          s = {
              urun: '72pt',
              big: '140pt',
              small: '70pt',
              tl: '45pt',
              logoH: '1.8cm',
              info: '12pt',
              barcodeH: '1.0cm'
          };
      }
      else if (sizeClass === 'size-a3') {
          s = { urun:'100pt', big:'250pt', small:'100pt', tl:'60pt', logoH:'3cm', info:'16pt', barcodeH:'2.5cm' };
      }
      else if (sizeClass === 'size-shelf') {
          // RAF ETİKETİ: Minimal
          let bigFont = '110px';
          if(tam.length >= 3) bigFont = '90px'; 

          s = { 
              urun:'24pt', 
              big: bigFont, 
              small:'35px', 
              tl:'20px', 
              logoH:'1.0cm', 
              info:'9pt', 
              barcodeH:'0.6cm',
              isShelf: true 
          };
      }
      else {
          s = { urun:'20pt', big:'60pt', small:'30pt', tl:'16pt', logoH:'1cm', info:'8pt', barcodeH:'1cm' };
      }

      // Şerit Etiket için
      if(sizeClass === 'strip-label') return stripLabelGenerate(product, baslik, isCampaign, tam, kurus, isYerli, uretimYeri, satisFiyat, dinamikBirimText);

      // --- HTML OLUŞTURMA ---
      
      let headerHtml = '';
      if(isCampaign){
         headerHtml = `
          <div class="header-box w-full bg-black text-white p-2 mb-4">
             <h1 class="font-black text-5xl leading-none uppercase tracking-tighter">${baslik}</h1>
             ${altBaslik ? `<div class="text-xl mt-1 font-bold border border-white inline-block px-4 rounded-full">${altBaslik}</div>` : ''}
          </div>`;
      }

      // KATLAMA ALANI (Sadece Raf Etiketi için)
      let foldHtml = '';
      if(sizeClass === 'size-shelf') {
        foldHtml = `<div class="fold-area"><span>⬇️ RAF (3.5cm) ⬇️</span></div>`;
      }

      // Yerli Logo HTML (Sola dayalı)
      const yerliLogoHtml = isYerli
        ? `<div class="yerli-logo-box" style="height:${s.logoH};">
             <i class="fa-solid fa-handshake-simple mr-2" style="font-size:calc(${s.logoH} * 0.6)"></i>
             <div class="flex flex-col leading-none font-bold" style="font-size:calc(${s.logoH} * 0.35)"><span>YERLİ</span><span>ÜRETİM</span></div>
           </div>`
        : `<div class="font-bold border border-black px-2 flex items-center justify-center rounded" style="height:${s.logoH}; font-size:calc(${s.logoH} * 0.3)">MENŞEİ: ${uretimYeri}</div>`;

      // KDV Yazısı
      const kdvText = 'K.D.V DAHİL FİYATTIR';
      const kdvHtml = `<div class="font-bold mt-1 text-center whitespace-nowrap" style="font-size:${s.isShelf ? '8px' : '10pt'};">${kdvText}</div>`;

      const bodyHtml = `
        <div class="content-box w-full bg-white flex flex-col items-center justify-center flex-1">
          
          <h2 class="text-center font-black text-black leading-none uppercase ${sizeClass==='size-shelf'?'clamp-2':''}" 
              style="font-size:${s.urun}; margin-bottom:${s.isShelf ? '0' : '10px'};">
              ${product.ad}
          </h2>

          ${isCampaign ? `<div class="text-3xl font-bold text-gray-400 line-through mb-2">${normalFiyat.toFixed(2)}</div>` : ''}

          <div class="price-row text-black">
            <span class="price-left font-black leading-none" style="font-size:${s.big};">${tam}</span>
            <div class="price-right">
              <span class="kurus font-black" style="font-size:${s.small};">${kurus}</span>
              <span class="tl font-black" style="font-size:${s.tl}; margin-top:${s.isShelf ? '5px' : '5px'};">TL</span>
            </div>
          </div>
          
          ${dipNot ? `<div class="bg-black text-white text-xl font-bold px-4 py-1 mt-2 rounded">${dipNot}</div>` : ''}
        </div>
        
        <div class="footer-info">
          <div class="flex flex-col gap-1 w-1/2 items-start justify-end">
            ${yerliLogoHtml}
            <div class="flex flex-col leading-tight font-bold text-gray-700 text-left" style="font-size:${s.info};">
              <span>Menşei: ${uretimYeri}</span>
              <span>Fiy.Değ.Tar: ${product.tarih}</span>
              <span>${dinamikBirimText}</span>
            </div>
          </div>
          
          <div class="flex flex-col items-end w-1/2 justify-end">
             <div class="barcode-container">
               <svg class="barcode-gen" 
                    jsbarcode-value="${product.barkod}" 
                    style="height:${s.barcodeH}; display:block;"></svg>
               ${kdvHtml}
             </div>
          </div>
        </div>
      `;

      el.innerHTML = foldHtml + headerHtml + `<div class="w-full flex-1 flex flex-col justify-between">${bodyHtml}</div>`;
      return el;
    }

    // --- ŞERİT ETİKET ---
    function stripLabelGenerate(product, baslik, isCampaign, tam, kurus, isYerli, uretimYeri, satisFiyat, dinamikBirimText){
       const el = document.createElement('div');
       el.className = 'strip-label';
       
       const yerliHtml = isYerli 
         ? `<div class="border border-black px-1 rounded text-[10px] font-bold">YERLİ</div>` 
         : `<div class="text-[10px] font-bold">İTHAL</div>`;

       const bodyHtml = `
          <div class="strip-left">
             ${isCampaign ? `<div class="bg-black text-white text-center py-1 font-bold text-xl">${baslik}</div>` : ``}
             <div class="font-black uppercase text-4xl leading-none clamp-2 mt-2">${product.ad}</div>
             <div class="mt-auto flex justify-between items-end">
                ${yerliHtml}
                <div class="text-[10px] font-bold text-right">
                   <div>${product.tarih}</div>
                   <div>${dinamikBirimText}</div>
                </div>
             </div>
             <div class="mt-1"><svg class="barcode-gen" jsbarcode-value="${product.barkod}" style="height:25px; width:100%;"></svg></div>
          </div>
          <div class="strip-right">
             <div class="flex flex-col items-center">
               <div class="price-row">
                 <span class="font-black text-[90px] leading-none">${tam}</span>
                 <div class="flex flex-col ml-2 pt-4">
                   <span class="font-black text-[40px] leading-none">${kurus}</span>
                   <span class="text-xl font-bold">TL</span>
                 </div>
               </div>
               <div class="text-[8px] font-bold mt-1">KDV DAHİL</div>
             </div>
          </div>
       `;
       el.innerHTML = bodyHtml;
       return el;
    }
  </script>
</body>
</html>
